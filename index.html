<!DOCTYPE html>
<html>
  <head>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <style>
      body {
	background-color: #000;
	color: #aaa;
      }
    </style>
  </head>
  <body>
    <button id="play">play</button>
    <button id="stop">stop</button>
    <select name="mode" id="mode">
      <optgroup label="Intervals">
        <option value="intervals:*">All</option>
      </optgroup>
      <optgroup label="Chord qualities">
        <option value="chords:*">All</option>
      </optgroup>
      <optgroup label="Solfege">
        <option value="solfege:do,re,mi,fa,sol,la,ti">Diatonic</option>
        <option value="solfege:*">Chromatic</option>
      </optgroup>
    </select>
    <input type="checkbox" id="inversions">Use inversions</input>
  </body>
  <script type="module">
    import { SplendidGrandPiano } from "https://unpkg.com/smplr/dist/index.mjs"; // needs to be a url
    const audio = new AudioContext(); // create the audio context
    const piano = new SplendidGrandPiano(audio); // create and load the instrument
    const intervals = [
      {
        name: "m2",
	notes: [0, 1],
	spokenName: "Minor 2nd",
      },
      {
        name: "M2",
	notes: [0, 2],
	spokenName: "Major 2nd",
      },
      {
        name: "m3",
	notes: [0, 3],
	spokenName: "Minor 3rd",
      },
      {
        name: "M3",
	notes: [0, 4],
	spokenName: "Major 3rd",
      },
      {
        name: "P4",
	notes: [0, 5],
	spokenName: "Perfect 4th",
      },
      {
        name: "TT",
	notes: [0, 6],
	spokenName: "Tritone",
      },
      {
        name: "P5",
	notes: [0, 7],
	spokenName: "Perfect 5th",
      },
      {
        name: "m6",
	notes: [0, 8],
	spokenName: "Minor 6th",
      },
      {
        name: "M6",
	notes: [0, 9],
	spokenName: "Major 6th",
      },
      {
        name: "m7",
	notes: [0, 10],
	spokenName: "Minor 7th",
      },
      {
        name: "M7",
	notes: [0, 11],
	spokenName: "Major 7th",
      },
      {
        name: "O",
	notes: [0, 12],
	spokenName: "Octave",
      },
    ];
    const chords = [
      {
        name: "",
        notes: [0, 4, 7],
        spokenName: "Major",
      },
      {
        name: "m",
        notes: [0, 3, 7],
        spokenName: "Minor",
      },
      {
        name: "dim",
        notes: [0, 3, 6],
        spokenName: "Diminished",
      },
      {
        name: "+",
        notes: [0, 4, 8],
	spokenName: "Augmented",
      },
      {
        name: "7",
        notes: [0, 4, 7, 10],
        spokenName: "Dominant 7th",
      },
      {
        name: "m7",
        notes: [0, 3, 7, 10],
        spokenName: "Minor 7th",
      },
      {
        name: "M7",
        notes: [0, 4, 7, 11],
        spokenName: "Major 7th",
      },
      {
        name: "mM7",
        notes: [0, 3, 7, 11],
        spokenName: "Minor major 7th",
      },
    ];


    async function speak(message) {
      return new Promise(r => {
        var utter = new SpeechSynthesisUtterance(message);
        window.speechSynthesis.speak(utter);
        utter.onend = r;
      });
    }

    async function sleep(duration) {
      return new Promise(r => setTimeout(r, duration))
    }

    async function playArpeggio(piano, key, notes, duration) {
      const now = audio.currentTime;
      const increment = duration / notes.length;
      notes.forEach((note, i) => {
        piano.start({ note: key + note, time: now + i*increment, duration: increment });
      });
      await sleep(duration*1000 + 500);
    }

    async function playChord(piano, key, notes, duration) {
      for (const note of notes) {
        piano.start({ note: key + note, duration: duration });
      }
      await sleep(duration*1000);
    }

    async function singleQuiz(piano, key, notes, spokenName) {
      await playChord(piano, key, notes, 1);
      await playArpeggio(piano, key, notes, notes.length * 0.5)
      await playChord(piano, key, notes, 3);
      await speak(spokenName)
    }
    
    // returns a random integer in [floor, ceiling]
    function randomInt(floor, ceiling) {
      if (ceiling < floor) return nan;
      return floor + Math.floor(Math.random() * (ceiling - floor + 1))
    }

    function noteName(note) {
      const noteNames = ["C", "Db", "D", "Eb", "E", "F", "Gb", "G", "Ab", "A", "Bb", "B"];
      const index = note % 12;
      return noteNames[index];
    }

    let playing = false;

    document.getElementById("stop").onclick = async () => {
      playing = false;
    }
    
    document.getElementById("play").onclick = async () => {
      if (playing) return;
      playing = true;
      audio.resume(); // enable audio context after a user interaction
      // Request screen wake lock.  TODO: Apparently:
      //  - this will only work with https
      //  - we will need to detect visibility changes and re-request the screen lock.
      try {
        const wakeLock = await navigator.wakeLock.request("screen");
      } catch (err) {
        console.log(`${err.name}, ${err.message}`);
      }

      while (playing) {
        // 48 is the C below middle C, 59 is the B below middle C. We'll stay with the 
	// key note in this octave.
        const key = randomInt(48,59);
        const chord = chords[randomInt(0, chords.length-1)];
        const useInversions = document.getElementById("inversions").checked
        const inversion = useInversions ? randomInt(0, chord.notes.length-1) : 0;
        let notes = invertChord(chord.notes, inversion);

        console.log(`Playing ${noteName(key)}${chord.name}, inversion ${inversion}: ${notes.map(x => x+key).sort().map(noteName)}`);
        await singleQuiz(piano, key, notes, chord.spokenName);
        await sleep(1000);
      }
    };

    function invertChord(notes, inversion) {
      let inverted = []
      for (let i = inversion; i < inversion + notes.length; ++i) {
	inverted.push(notes[i % notes.length] + 12 * Math.floor(i / notes.length));
      }
      return inverted;
    }
  </script>
</html>
